% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/codificacion.R
\name{construir_plantilla_desde_familias_repeat}
\alias{construir_plantilla_desde_familias_repeat}
\title{Construir plantilla de codificación (multi-hoja, repeat-aware, con labels en español)}
\usage{
construir_plantilla_desde_familias_repeat(inst, tabs, fam)
}
\arguments{
\item{inst}{Lista del instrumento XLSForm.
Debe incluir al menos \verb{$survey} y \verb{$choices}.
Idealmente también \verb{$survey_raw} y \verb{$choices_raw} con etiquetas multilingües
(especialmente en español).}

\item{tabs}{Lista de hojas de datos (por ejemplo, leídas con \code{openxlsx} o \code{readxl}).
Cada elemento \strong{debe ser un \code{data.frame}} (main y repeats).
Si algún elemento no es \code{data.frame}, se omitirá con un \emph{warning}.}

\item{fam}{Lista devuelta por \code{leer_familias_clasificar_repeat()} que contiene:
\itemize{
\item \code{select_one}, \code{select_multiple}, \code{text}, \code{integer} — familias aceptadas.
\item Opcionalmente \code{choices_usadas} y \code{adopciones}.
}
Cada subtabla debe incluir las columnas:
\code{section}, \code{hoja_datos}, \code{tipo}, \code{parent}, \code{parent_label},
\code{list_norm}, \code{parent_col}, \code{other_dummy_col}, \code{text_col}, \code{q_order}.}
}
\value{
Una lista con los siguientes elementos:
\describe{
\item{\code{diccionario}}{Metadatos del XLSForm (orden, variable, etiqueta, tipo base, list\_name).}
\item{\code{choices}}{Catálogo de opciones final (labels en español) por familia.}
\item{\code{familias}}{Tabla consolidada de familias aceptadas.}
\item{\code{navegacion}}{Tabla resumen con hoja, tipo y número de registros (\code{n}).}
\item{\code{sheets}}{Lista de \code{data.frame}s (una hoja por variable) con atributos:
\code{header_raw}, \code{label_row} (labels ES) y \code{tipo}.}
}
}
\description{
Versión \strong{repeat-aware} del constructor de plantilla. Usa el \emph{split} devuelto por
\code{leer_familias_clasificar_repeat()} (o equivalente) y un objeto \code{tabs} con las
hojas de datos (main y repeats).

Esta función crea automáticamente una plantilla de codificación multi-hoja
que respeta el orden original del XLSForm (\code{q_order}) e integra todas las
familias \strong{select_one}, \strong{select_multiple}, \strong{text} e \strong{integer}.
\subsection{Características principales}{
\itemize{
\item Soporta formularios con \emph{grupos repeat} (identifica correctamente cada hoja).
\item Crea una hoja por variable (\code{parent_col}) con identificadores robustos
(\verb{_uuid}, \verb{_index}, \verb{Código pulso}).
\item Reconoce y vincula variables hijas con sus familias (soportando \code{other_dummy_col} y \code{text_col}).
\item Incluye vínculos \verb{_parent_index} y \verb{_submission__uuid} si existen.
\item Excluye \code{text} adoptadas según la lógica de \code{adopciones} en \code{fam}.
\item Integra catálogos de opciones (\code{choices}) directamente desde el instrumento XLSForm,
priorizando etiquetas en español (\code{label::Español (es)}, \code{label_spanish_es}, etc.).
\item Reetiqueta las columnas de las hojas \strong{select_multiple} con los \emph{labels} en español
(en lugar de códigos).
\item Recalcula en las hojas \strong{select_one} la columna \code{"Selección (label)"}
para que refleje siempre el texto en español correspondiente al código.
}
}

\subsection{Flujo recomendado}{

\if{html}{\out{<div class="sourceCode r">}}\preformatted{inst <- leer_instrumento_xlsform("instrumento.xlsx")
tabs <- lector_codif_repeat("datos.xlsx", main_sheet="main", repeat_sheets=c("hogar","ninos"))
fam  <- leer_familias_clasificar_repeat("familias.xlsx", inst, tabs)
pl   <- construir_plantilla_desde_familias_repeat(inst, tabs, fam)
exportar_plantilla_codificacion_xlsx(pl, "Plantilla.xlsx", inst)
}\if{html}{\out{</div>}}
}
}
\details{
\itemize{
\item Los \strong{select_one} generan columnas: \code{"Selección (código)"}, \code{"Selección (label)"},
\code{"Recodificación"}, \code{"Control"}, y opcionalmente columnas de texto auxiliar.
\item Los \strong{select_multiple} expanden las opciones a columnas \emph{dummy} (0/1),
nombradas con los \emph{labels} en español, más sus columnas \verb{*_recod}.
\item Los \strong{integer} y \strong{text} conservan la estructura original y añaden
una columna \verb{*_recod} y \code{"Control"}.
\item Se respeta el orden de las variables según \code{q_order} del XLSForm original.
}
}
\examples{
\dontrun{
inst <- leer_instrumento_xlsform("instrumento.xlsx")
tabs <- lector_codif_repeat("datos.xlsx", main_sheet="main", repeat_sheets=c("hogar","ninos"))
fam  <- leer_familias_clasificar_repeat("familias.xlsx", inst, tabs)
pl   <- construir_plantilla_desde_familias_repeat(inst, tabs, fam)
pl$sheets$IDP01  # Hoja expandida con dummy-labels en español
}

}
\seealso{
\itemize{
\item \code{\link[=leer_familias_clasificar_repeat]{leer_familias_clasificar_repeat()}} para clasificar familias de variables.
\item \code{\link[=exportar_plantilla_codificacion_xlsx]{exportar_plantilla_codificacion_xlsx()}} para exportar la plantilla final.
}
}
